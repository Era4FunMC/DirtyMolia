From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MrHua269 <wangxyper@163.com>
Date: Wed, 19 Jul 2023 22:02:14 +0800
Subject: [PATCH] Rework patch Fix can not move entity off main


diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 05bf20e2765e5fb6f32b81cfdec5ea2f47f3c959..2310f588943e8885612a5e807ebcb0330309c072 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -7,6 +7,7 @@ import com.google.common.collect.Lists;
 import com.google.common.collect.Sets;
 import com.google.common.collect.UnmodifiableIterator;
 import com.mojang.logging.LogUtils;
+import io.papermc.paper.util.TickThread;
 import it.unimi.dsi.fastutil.objects.Object2DoubleArrayMap;
 import it.unimi.dsi.fastutil.objects.Object2DoubleMap;
 import java.util.Arrays;
@@ -1128,7 +1129,21 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
                     }
                 }
 
-                this.setPos(this.getX() + vec3d1.x, this.getY() + vec3d1.y, this.getZ() + vec3d1.z);
+                var targetX = this.getX() + vec3d1.x;
+                var targetZ = this.getZ() + vec3d1.z;
+
+                if (!TickThread.isTickThreadFor(((ServerLevel) this.level()),targetX,targetZ)) {
+                    this.teleportAsync((ServerLevel) this.level(), this.position().add(vec3d1),
+                            this.getYRot(),
+                            this.getXRot(),
+                            null,
+                            PlayerTeleportEvent.TeleportCause.UNKNOWN,
+                            Entity.TELEPORT_FLAG_LOAD_CHUNK | Entity.TELEPORT_FLAG_TELEPORT_PASSENGERS,
+                            null
+                    );
+                }else{
+                    this.setPos(this.getX() + vec3d1.x, this.getY() + vec3d1.y, this.getZ() + vec3d1.z);
+                }
             }
 
             this.level().getProfiler().pop();
